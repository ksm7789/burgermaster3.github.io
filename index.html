<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
<title>버거 만들기 게임</title>
<style>
:root{
  --bg:#0f172a;--ink:#f1f5f9;--muted:#94a3b8;--brand:#f97316;--ok:#10b981;--bad:#ef4444;
  --stackW:85px;--stackH:100px;--card-bg:#1e293b;--card-border:#334155;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);
  color:var(--ink);min-height:100vh;
  padding-top: env(safe-area-inset-top);
  transition: background 0.5s;
}
/* 테마별 배경 스타일 */
body.theme-day { background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%); }
body.theme-sunset { background: linear-gradient(135deg, #FF7F50 0%, #FFB6C1 100%); }
body.theme-space { background: linear-gradient(135deg, #191970 0%, #483D8B 100%); }

header{
  position:sticky;top:0;z-index:100;
  background:rgba(15,23,42,0.95);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--card-border);
  padding:6px 10px;display:flex;gap:8px;align-items:center;
  box-shadow:0 4px 24px rgba(0,0,0,0.3);
}
.title-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
}
header h1{
  font-size:14px;font-weight:900;
  background:linear-gradient(135deg,#f97316,#fb923c);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  cursor:pointer;transition:transform 0.2s;
  line-height: 1.2;
}
.btn-start, #resetBtn {
  padding:6px 12px;font-size:11px;border-radius:10px;
  color:#fff;border:none;cursor:pointer;font-weight:700;
  transition: all 0.2s;
}
.btn-start {
  background:linear-gradient(135deg,#f97316,#fb923c);
}
#resetBtn {
  background: rgba(22, 163, 74, 0.3);
  border: 1px solid rgba(34, 197, 94, 0.5);
  color: #6ee7b7;
  display: none;
}
#resetBtn:active {
  transform: scale(0.95);
  background: rgba(22, 163, 74, 0.5);
}
.header-info {
  display: none;
  margin-left: auto;
  align-items: center;
  gap: 12px;
  font-size: 11px;
  font-weight: 600;
}
header.game-started .header-info {
  display: flex;
}
header.game-started .btn-start {
  display: none;
}
header.game-started #resetBtn {
  display: block;
}
header.game-started #orderName {
  display: none;
}
#level { color: #fb923c; }

/* 모드 버튼 스타일 */
#modeBtn {
  font-weight: 700;
  padding: 6px 10px;
  font-size: 11px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
}
#modeBtn.sprout-mode { background-color: #a3e635; color: #1e293b; }
#modeBtn.stem-mode { background-color: #facc15; color: #1e293b; }
#modeBtn.flower-mode { background-color: #f9a8d4; color: #1e293b; }
#modeBtn:active { transform: scale(0.95); }

main{padding:8px;max-width:100%;margin:0 auto}
.banner{
  background:rgba(251,146,60,0.15);border:2px solid rgba(251,146,60,0.3);
  border-radius:12px;padding:8px 10px;margin-bottom:8px;
  font-size:11px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
}
.banner-content { display: flex; gap: 8px; align-items: center;}
#countdown-timer {
  font-size: 14px;
  font-weight: bold;
  color: var(--brand);
}
.banner.hide{display:none}

.burger-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.card{
  background:var(--card-bg);border:1px solid var(--card-border);
  border-radius:12px;overflow:hidden;
}
.card h2{
  padding:5px 8px;background:rgba(248,250,252,0.05);
  border-bottom:1px solid var(--card-border);
  font-size:10px;font-weight:700;
}
.card .content{padding:6px}

.stack-wrap{
  display:flex;
  justify-content:center;
  align-items: flex-end;
  min-height:160px;
  position:relative;
}
.stack{
  position:relative;
  width:75px;
  height: 150px;
  border:2px dashed rgba(148,163,184,0.3);border-radius:12px;
  background:repeating-linear-gradient(-45deg,rgba(30,41,59,0.5),rgba(30,41,59,0.5) 6px,rgba(51,65,85,0.3) 6px,rgba(51,65,85,0.3) 12px);
}
.plate{
  position:absolute;left:50%;bottom:6px;transform:translateX(-50%);
  width:calc(var(--stackW) + 30px);height:10px;
  border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,0.5);
}
.ingredient{
  position:absolute;left:50%;transform:translateX(-50%);
  transition:all 0.2s;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.4));
}
.targetGhost{opacity:0.4}

.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.tile{
  display:flex;flex-direction:column;align-items:center;gap:5px;
  padding:14px 8px;border:2px solid var(--card-border);
  border-radius:12px;background:rgba(51,65,85,0.5);
  cursor:pointer;transition:all 0.2s;min-height:90px;
}
.tile:active{transform:scale(0.95)}
.ico{width:50px;height:50px;display:grid;place-items:center}
.name{font-size:11px;color:var(--muted);font-weight:600}

.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.btn{
  padding:14px 12px;border-radius:12px;border:none;
  cursor:pointer;font-weight:700;font-size:13px;
  transition:all 0.2s;
}
.btn.secondary{background:#334155;color:var(--ink);min-width:52px}
.btn.primary{background:linear-gradient(135deg,#f97316,#fb923c);color:#fff;flex:1}

.inventory-bar {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    padding: 8px;
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
    min-height: 50px;
}
.inventory-bar.hidden {
    display: none;
}
.inventory-item {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 10px;
    padding: 8px;
    text-align: center;
    cursor: pointer;
    position: relative;
    flex: 1;
}
.inventory-item .item-icon { font-size: 16px; font-weight: bold; }
.inventory-item .item-count {
    position: absolute;
    bottom: 2px;
    right: 4px;
    font-size: 10px;
    background: var(--brand);
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    line-height: 16px;
}

.toast{
  position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
  background:rgba(15,23,42,0.95);color:#fff;
  padding:10px 14px;border-radius:12px;
  opacity:0;pointer-events:none;transition:all 0.3s;
  font-size:12px;z-index:1000;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-8px)}

dialog{
  border:none;border-radius:20px;padding:0;
  background:var(--card-bg);max-width:90%;
  width: 280px;
}
dialog#result, dialog#marketModal, dialog#finalScoreScreen {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
dialog::backdrop{background:rgba(0,0,0,0.8)}
.modal{padding:24px 20px}
.modal h3{font-size:36px;text-align:center;margin-bottom:12px}
.modal p{text-align:center;margin-bottom:16px;color:var(--muted)}
.modal .stats{
  background:rgba(51,65,85,0.5);padding:12px;
  border-radius:12px;margin-bottom:16px;font-size:12px;
}
.stat-row{
  display:flex;justify-content:space-between;padding:6px 0;
  border-bottom:1px solid rgba(148,163,184,0.1);
}
.stat-row:last-child{border:none}
.modal .row{display:flex;gap:8px}
.leaderboard{
  background:rgba(51,65,85,0.3);border-radius:10px;
  padding:10px;margin-top:12px;
}
.leaderboard h4{font-size:12px;color:#fb923c;margin-bottom:8px}
.lb-item{
  display:flex;justify-content:space-between;padding:6px 10px;
  background:rgba(51,65,85,0.4);border-radius:8px;margin-bottom:4px;
  font-size:11px;
}

#levelUpModal, #comboModal, #scorePopupModal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border: none;
  background: transparent;
  padding: 0;
  width: 100%;
  overflow: visible;
  pointer-events: none;
}
#levelUpModal::backdrop, #comboModal::backdrop, #scorePopupModal::backdrop {
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(5px);
}
#levelUpText, #comboText, #scorePopupText {
  font-size: 8vw;
  font-weight: 900;
  color: #fff;
  text-align: center;
  text-shadow: 0 0 10px var(--brand), 0 0 20px var(--brand), 0 0 40px var(--brand);
  animation: levelUpPop 2.5s ease-out forwards;
}
.fireworks-container {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 1px;
  height: 1px;
}
.particle {
  position: absolute;
  width: 5px;
  height: 5px;
  border-radius: 50%;
  opacity: 0;
  animation: firework-pop 1.5s ease-out forwards;
}

@keyframes levelUpPop {
  0% { transform: scale(0.3) translateY(20px); opacity: 0; }
  30% { transform: scale(1.1); opacity: 1; }
  50% { transform: scale(1) translateY(0); opacity: 1; }
  100% { transform: scale(1); opacity: 0; }
}
@keyframes firework-pop {
  0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  100% { transform: translate(var(--x), var(--y)) scale(0); opacity: 0; }
}

/* 마켓 스타일 */
#marketModal .modal-content { max-height: 80vh; overflow-y: auto; }
#marketModal h4 { color: var(--brand); margin: 16px 0 8px; font-size: 14px; }
.item-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
.item-card { background: rgba(0,0,0,0.2); border: 1px solid var(--card-border); border-radius: 12px; padding: 12px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; }
.cosmetic-item[data-unlocked="true"] { cursor: pointer; transition: border-color 0.2s; }
.cosmetic-item[data-unlocked="true"]:not([data-active="true"]):hover { border-color: var(--brand); }
.cosmetic-item[data-active="true"] { border-color: var(--ok); }
.item-icon {
    font-size: 28px;
    font-weight: bold;
    line-height: 1;
    margin-bottom: 8px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.item-icon .plate {
    position: static; transform: none; width: 50px; height: 7px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.5);
}
.item-name { font-size: 12px; font-weight: 600; color: #fff; }
.item-desc { display: none; }
.item-price { font-size: 14px; font-weight: bold; color: #fff; margin-top: 8px; }
.item-card button { width: 100%; margin-top: 8px; padding: 8px; font-size: 11px; }
.item-card button:disabled {
    background: #555 !important;
    background-image: none !important;
    cursor: not-allowed;
    opacity: 0.6;
}
.item-card .equipped { color: var(--ok); font-size: 10px; font-weight: bold; margin-top: 4px; min-height: 14px; }

/* 최종 점수 화면 스타일 */
#finalScoreScreen {
    text-align: center;
}
#finalScoreScreen h2 {
    font-size: 20px;
    color: var(--muted);
    margin-bottom: 8px;
}
#finalScoreValue {
    font-size: 60px;
    font-weight: 900;
    color: var(--brand);
    margin-bottom: 16px;
}
#finalLeaderboard {
    margin-top: 8px;
}
#finalLeaderboard .leaderboard {
    text-align: left;
}
</style>
</head>
<body>
<header id="header">
  <div class="title-wrap">
    <h1 id="gameTitle">🍔버거 마스터</h1>
    <button class="btn-start" id="startBtn">▶ 시작</button>
    <button id="resetBtn">다시하기</button>
    <span id="orderName">대기중</span>
  </div>
  <div class="header-info">
    <span>💎 <span id="score">0</span></span>
    <button id="modeBtn" class="sprout-mode">새싹</button>
    <span id="levelDisplay">LV.<span id="level">1</span></span>
  </div>
</header>

<div id="banner" class="banner hide">
  <div class="banner-content">
    <span>👨‍🍳</span>
    <div><strong>버거 마스터!</strong><br><span style="font-size:9px">주문과 똑같이 만들어보세요.</span></div>
  </div>
  <div id="countdown-timer">남은 시간: -</div>
</div>

<main>
  <div class="burger-row">
    <section class="card">
      <h2>📋 주문</h2>
      <div class="content">
        <div class="stack-wrap">
          <div id="target" class="stack"><div class="plate"></div></div>
        </div>
      </div>
    </section>
    <section class="card">
      <h2>🎯 내 버거</h2>
      <div class="content">
        <div class="stack-wrap">
          <div id="mine" class="stack"><div class="plate"></div></div>
        </div>
      </div>
    </section>
  </div>

  <section class="card">
    <h2>🥬 재료 선택</h2>
    <div class="content">
      <div class="grid" id="palette"></div>
      <div class="controls">
        <button class="btn secondary" id="undo">↩</button>
        <button class="btn secondary" id="clear">🗑</button>
        <button class="btn secondary" id="peekBtn">👀</button>
        <button class="btn primary" id="submit">✅ 제출</button>
      </div>
      <div class="inventory-bar" id="inventory-bar"></div>
    </div>
  </section>
</main>

<div class="toast" id="toast"></div>

<dialog id="result">
  <div class="modal">
    <h3 id="resultTitle">🎉</h3>
    <div id="resultStats" class="stats"></div>
    <p id="resultMsg"></p>
    <div class="row">
      <button class="btn primary" id="next" style="flex:1">다음 →</button>
      <button class="btn primary" id="continueBtn" style="flex:1; display: none;">
        이어하기
        <small style="display: block; font-size: 10px; opacity: 0.8;">💎 -10000점</small>
      </button>
      <button class="btn secondary" id="resultMarketBtn">🛒 마켓</button>
      <button class="btn secondary" id="closeModal">닫기</button>
    </div>
    <div id="leaderboard"></div>
  </div>
</dialog>

<dialog id="levelUpModal">
  <div class="fireworks-container"></div>
  <h2 id="levelUpText">1단계 통과!</h2>
</dialog>

<dialog id="comboModal">
  <div class="fireworks-container"></div>
  <h2 id="comboText">5콤보 축하!</h2>
</dialog>

<dialog id="scorePopupModal">
  <div class="fireworks-container"></div>
  <h2 id="scorePopupText">+10000점!</h2>
</dialog>

<dialog id="marketModal">
    <div class="modal modal-content">
        <h3>🛒 마켓</h3>
        <p>💎 <span id="marketScore">0</span></p>
        <div id="market-items"></div>
        <button class="btn secondary" id="closeMarketModal" style="margin-top: 16px;">닫기</button>
    </div>
</dialog>

<dialog id="finalScoreScreen">
    <div class="modal">
        <h2>최종 점수</h2>
        <h1 id="finalScoreValue">0</h1>
        <div id="finalLeaderboard"></div>
    </div>
</dialog>


<script>
const SVGs = {
  topbun: w => `<svg width="${w}" height="24" viewBox="0 0 220 40"><defs><linearGradient id="gt" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#f6b26b"/><stop offset="1" stop-color="#e49a48"/></linearGradient></defs><path d="M10 40h200c4 0 8-4 8-8C218 9 189 0 110 0S2 9 2 32c0 4 4 8 8 8z" fill="url(#gt)" stroke="#d98b3d" stroke-width="2"/><g fill="#ffe6b3" opacity="0.8"><circle cx="40" cy="18" r="3"/><circle cx="90" cy="12" r="2.6"/><circle cx="140" cy="16" r="2.6"/><circle cx="180" cy="10" r="2.2"/></g></svg>`,
  bottombun: w => `<svg width="${w}" height="18" viewBox="0 0 220 30"><defs><linearGradient id="gb" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#e49a48"/><stop offset="1" stop-color="#cf8a3e"/></linearGradient></defs><rect x="8" y="0" width="204" height="24" rx="10" fill="url(#gb)" stroke="#b87832" stroke-width="2"/><rect x="0" y="22" width="220" height="8" rx="4" fill="#b87832"/></svg>`,
  patty: w => `<svg width="${w}" height="16" viewBox="0 0 220 26"><rect x="8" y="2" width="204" height="20" rx="8" fill="#6b3f2a" stroke="#4c2b1b" stroke-width="2"/><circle cx="50" cy="12" r="2" fill="#8b5a3c" opacity="0.6"/><circle cx="110" cy="14" r="2.5" fill="#8b5a3c" opacity="0.6"/><circle cx="170" cy="11" r="2" fill="#8b5a3c" opacity="0.6"/></svg>`,
  cheese: w => `<svg width="${w}" height="14" viewBox="0 0 220 22"><path d="M8 2h204v10l-18 8-18-8-18 8-18-8-18 8-18-8-18 8-18-8-18 8-18-8V2z" fill="#ffd64d" stroke="#e3b600" stroke-width="2"/><circle cx="60" cy="8" r="3" fill="#ffe180"/></svg>`,
  lettuce: w => `<svg width="${w}" height="11" viewBox="0 0 220 18"><path d="M8 12c12-10 24 6 36 0s24 6 36 0 24 6 36 0 24 6 36 0 24 6 36 0l10-4H8z" fill="#4ade80" stroke="#16a34a" stroke-width="2"/></svg>`,
  tomato: w => `<svg width="${w}" height="10" viewBox="0 0 220 16"><rect x="8" y="2" width="204" height="12" rx="6" fill="#ef4444" stroke="#b91c1c" stroke-width="2"/><ellipse cx="80" cy="8" rx="8" ry="4" fill="#f87171" opacity="0.5"/></svg>`,
  onion: w => `<svg width="${w}" height="9" viewBox="0 0 220 14"><rect x="8" y="2" width="204" height="10" rx="6" fill="#e5e7eb" stroke="#cbd5e1" stroke-width="2"/></svg>`,
  pickle: w => `<svg width="${w}" height="8" viewBox="0 0 220 12"><rect x="8" y="2" width="204" height="8" rx="6" fill="#22c55e" stroke="#16a34a" stroke-width="2"/></svg>`,
  sauce: w => `<svg width="${w}" height="7" viewBox="0 0 220 10"><path d="M8 6c10-8 22 4 34 0s22 4 34 0 22 4 34 0 22 4 34 0 22 4 34 0 22 4 34 0v2H8z" fill="#f97316"/></svg>`,
  plates: {
    default: `<div class="plate" style="background:linear-gradient(180deg,#64748b,#475569);"></div>`,
    gold: `<div class="plate" style="background:linear-gradient(180deg,#F7D060,#DAA520);"></div>`,
    rainbow: `<div class="plate" style="background:linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet);"></div>`
  }
};

const ORIGINAL_INGREDIENTS = [
  {key:'topbun',name:'윗빵'},{key:'lettuce',name:'양상추'},{key:'tomato',name:'토마토'},
  {key:'onion',name:'양파'},{key:'pickle',name:'피클'},{key:'cheese',name:'치즈'},
  {key:'patty',name:'패티'},{key:'sauce',name:'소스'},{key:'bottombun',name:'아랫빵'}
];

let ALL = [...ORIGINAL_INGREDIENTS];

const RECIPES = {
  easy:[{name:'기본버거',seq:['bottombun','patty','topbun'],difficulty:1},{name:'치즈버거',seq:['bottombun','patty','cheese','topbun'],difficulty:1}],
  medium:[{name:'상하이버거',seq:['bottombun','sauce','patty','lettuce','topbun'],difficulty:2},{name:'베지버거',seq:['bottombun','lettuce','tomato','onion','pickle','topbun'],difficulty:2},{name:'더블패티',seq:['bottombun','patty','cheese','patty','topbun'],difficulty:2}],
  hard:[{name:'디럭스버거',seq:['bottombun','sauce','pickle','cheese','patty','lettuce','topbun'],difficulty:3},{name:'풀옵션',seq:['bottombun','sauce','pickle','onion','tomato','lettuce','cheese','patty','topbun'],difficulty:3}]
};

const ALL_RECIPES = [...RECIPES.easy, ...RECIPES.medium, ...RECIPES.hard];

// 게임 상태 변수
let target=null,mine=[],startTime=0,score=0,combo=0,started=false,highScores=[],ghostShown=false;
let lastOrder = null, sfxAudioCtx = null, level = 1, countdownTimerId = null, timeLeft = 0, gameMode = 'sprout';

// 마켓 관련 변수
let inventory = { timeAdd: 0, stagePass: 0, scoreDoubler: 0 };
let unlockedCosmetics = { plates: ['default'], backgrounds: ['default'] };
let activeCosmetics = { plate: 'default', background: 'default' };
let scoreMultiplier = 1;

const marketItems = {
    powerUps: [
        { id: 'timeAdd', name: '시간 추가', desc: '', price: 2000, visual: '<div style="color: #fff;">+5</div>' },
        { id: 'stagePass', name: '통과 열쇠', desc: '', price: 10000, visual: '<div style="color: #fff;">🔑</div>' },
        { id: 'scoreDoubler', name: '점수 2배', desc: '', price: 1000, visual: '<div style="color: #fff;">x2</div>' }
    ],
    cosmetics: [
        { id: 'gold', type: 'plates', name: '황금 접시', desc: '', price: 20000, visual: SVGs.plates.gold },
        { id: 'rainbow', type: 'plates', name: '무지개 접시', desc: '', price: 10000, visual: SVGs.plates.rainbow },
        { id: 'day', type: 'backgrounds', name: '낮 테마', desc: '', price: 12000, visual: '☀️' },
        { id: 'sunset', type: 'backgrounds', name: '저녁 노을 테마', desc: '', price: 15000, visual: '🌅' },
        { id: 'space', type: 'backgrounds', name: '우주 테마', desc: '', price: 20000, visual: '🚀' }
    ]
};


const el=s=>document.querySelector(s);

function playSound(type){
  if (!sfxAudioCtx) return;
  try{
    if (sfxAudioCtx.state === 'suspended') sfxAudioCtx.resume();
    const ctx = sfxAudioCtx;
    const osc = ctx.createOscillator(),gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    const now = ctx.currentTime;
    
    if(type==='add'){ osc.frequency.value=800; gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now);osc.stop(now + 0.1); }
    else if(type==='success'){ osc.frequency.value=1200; gain.gain.setValueAtTime(0.15, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3); osc.start(now);osc.stop(now + 0.3); }
    else if(type==='fail'){ osc.frequency.value=200; gain.gain.setValueAtTime(0.15, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4); osc.start(now);osc.stop(now + 0.4); }
    else if(type==='coin'){
        const osc2 = ctx.createOscillator(); osc2.connect(gain);
        osc.frequency.setValueAtTime(1800, now); osc2.frequency.setValueAtTime(2200, now);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.start(now); osc2.start(now);
        osc.stop(now + 0.1); osc2.stop(now + 0.1);
    }
  }catch(e){ console.error("playSound Error:", e); }
}

function showToast(msg){
  const t=el('#toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),1200);
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function drawPalette(){
  const wrap=el('#palette');wrap.innerHTML='';
  ALL.forEach(item=>{
    const d=document.createElement('button');
    d.className='tile';
    d.innerHTML=`<div class="ico">${SVGs[item.key](50)}</div><div class="name">${item.name}</div>`;
    d.addEventListener('click',()=>addIngredient(item.key));
    wrap.appendChild(d);
  });
}

function clearStack(box){
  [...box.querySelectorAll('.ingredient, .plate')].forEach(n=>n.remove());
}

function drawStack(box,seq,ghost=false){
  clearStack(box);
  box.insertAdjacentHTML('beforeend', SVGs.plates[activeCosmetics.plate]);

  let y=16;
  seq.forEach(key=>{
    const img=document.createElement('div');
    img.className='ingredient'+(ghost?' targetGhost':'');
    img.dataset.key=key;img.style.bottom=y+'px';
    img.innerHTML=SVGs[key](100);
    box.appendChild(img);
    const h={topbun:24,bottombun:18,patty:16,cheese:14,lettuce:11,tomato:10,onion:9,pickle:8,sauce:7}[key]||12;
    y+=h-1;
  });
}

function startCountdown(isNewRound = true) {
  if (countdownTimerId) clearInterval(countdownTimerId);
  if (isNewRound) {
    if (gameMode === 'sprout') { timeLeft = 30 - (level - 1) * 3; } 
    else if (gameMode === 'stem') { timeLeft = 15 - (level - 11) * 2; }
    else if (gameMode === 'flower') { timeLeft = 10; }
  }
  
  el('#countdown-timer').style.display = 'block';
  el('#countdown-timer').textContent = `남은 시간: ${timeLeft}초`;
  countdownTimerId = setInterval(() => {
    timeLeft--;
    el('#countdown-timer').textContent = `남은 시간: ${timeLeft}초`;
    if (timeLeft <= 0) {
      clearInterval(countdownTimerId);
      if(gameMode === 'flower') flowerGameOver();
      else gameOver("시간 초과!");
    }
  }, 1000);
}

function newOrder(isNewRound = true){
  if (gameMode === 'stem' || gameMode === 'flower') { shuffleArray(ALL); drawPalette(); }
  
  const pool = ALL_RECIPES;
  let nextOrder;
  do { nextOrder = pool[Math.floor(Math.random() * pool.length)]; } 
  while (pool.length > 1 && lastOrder && nextOrder.name === lastOrder.name);

  target = nextOrder;
  lastOrder = target;
  
  drawStack(el('#target'), target.seq, false);
  
  if (gameMode === 'flower') {
    el('#banner').style.display = 'none';
    setTimeout(() => { 
      clearStack(el('#target')); 
      el('#target').insertAdjacentHTML('beforeend', SVGs.plates[activeCosmetics.plate]); 
      el('#banner').style.display = 'flex';
      startCountdown(true);
    }, 5000);
  } else {
    startCountdown(isNewRound);
  }
  
  mine = [];
  drawStack(el('#mine'), mine, false);
  startTime = performance.now();
  updateInventoryBar();
}

function addIngredient(key){
  if (!started) return;
  mine.push(key);
  drawStack(el('#mine'),mine,false);
  playSound('add');
  showToast(`${nameOf(key)} 추가`);
}

function undo(){
  if (!started || mine.length===0) return;
  const removed=mine.pop();drawStack(el('#mine'),mine,false);
  showToast(`${nameOf(removed)} 제거`);
}

function resetMine(){
  if (!started || mine.length===0) return;
  mine=[];drawStack(el('#mine'),mine,false);showToast('초기화 완료');
}

function check(forcePass = false){
  if(!started) { showToast('먼저 게임을 시작해주세요!'); return; }
  if(mine.length===0 && !forcePass){showToast('재료를 추가해주세요!');return}
  
  if (countdownTimerId) clearInterval(countdownTimerId);
  
  const ok = forcePass || (mine.length===target.seq.length && mine.every((k,i)=>k===target.seq[i]));
  const elapsed=(performance.now()-startTime)/1000;
  
  const modal=el('#result');
  
  if(gameMode === 'flower') {
    if(ok) {
      score += 10000;
      el('#score').textContent = score;
      saveHighScores();
      combo++;
      
      showScorePopup(() => {
        newOrder();
      });
    } else {
      flowerGameOver();
    }
    return;
  }

  if(ok){
    playSound('success');
    const base=100*target.difficulty;
    const timeBonus=Math.max(0,Math.round((timeLeft)*10));
    let gained = (base + timeBonus) * level;
    let multiplierText = '';
    
    if (scoreMultiplier > 1) {
        gained *= scoreMultiplier;
        multiplierText += `<div class="stat-row"><span>점수 2배! (x${scoreMultiplier})</span><span></span></div>`;
        scoreMultiplier = 1;
    }

    let plateMultiplier = 1;
    if (activeCosmetics.plate === 'gold') plateMultiplier = 3;
    if (activeCosmetics.plate === 'rainbow') plateMultiplier = 2;
    if (plateMultiplier > 1) {
        gained *= plateMultiplier;
        multiplierText += `<div class="stat-row"><span>특별 접시 보너스!</span><span>x${plateMultiplier}</span></div>`;
    }

    score+=gained;
    combo++;
    el('#score').textContent=score;
    
    el('#next').onclick = () => {
        modal.close();
        handleLevelUp();
    };

    el('#resultTitle').textContent='🎉 완벽해요!';
    el('#resultTitle').style.color='var(--ok)';
    el('#resultStats').innerHTML=`<div class="stat-row"><span>기본 점수</span><span>+${base}</span></div><div class="stat-row"><span>시간 보너스</span><span>+${timeBonus}</span></div><div class="stat-row"><span>레벨 보너스 (x${level})</span><span></span></div>${multiplierText}<div class="stat-row"><strong>총 획득 점수</strong><strong>+${gained}</strong></div>`;
    el('#resultMsg').innerHTML=`<strong style="color:var(--ok)">⏱ ${elapsed.toFixed(1)}초</strong>만에 완성!`;
    
    if (combo > 0 && combo % 5 === 0) {
        const powerUps = marketItems.powerUps;
        const randomItem = powerUps[Math.floor(Math.random() * powerUps.length)];
        inventory[randomItem.id]++;
        updateInventoryBar();
        showComboPopup(() => {
            showToast(`${randomItem.name} 획득!`);
            modal.showModal();
        });
    } else {
        modal.showModal();
    }
  }else{
    playSound('fail');
    combo=0;
    el('#next').onclick = () => { modal.close(); newOrder(false); };
    
    el('#resultTitle').textContent='😅 아쉬워요!';
    el('#resultTitle').style.color='var(--bad)';
    const idx=firstMismatchIndex(mine,target.seq);
    const hint=idx>=0&&idx<target.seq.length?`${idx+1}번째 층이 다릅니다`:'재료 구성이 다릅니다';
    el('#resultStats').innerHTML=`<div class="stat-row"><span>걸린 시간</span><span>${elapsed.toFixed(1)}초</span></div><div class="stat-row"><span>문제점</span><span style="color:var(--bad)">${hint}</span></div>`;
    el('#resultMsg').innerHTML=`<strong>정답:</strong><br>${target.seq.map(k=>nameOf(k)).join(' → ')}`;
    highScores.push(score);
    highScores = highScores.sort((a,b)=>b-a).slice(0,5);
    updateLeaderboard();
    saveHighScores();
    modal.showModal();
  }
}

function handleLevelUp() {
    if (gameMode === 'sprout') {
        if (level === 10) {
            transitionToStemMode();
            return;
        }
        const scoreToPass = 500 * level * (level + 1);
        if (score >= scoreToPass) {
            level++;
            el('#level').textContent = level;
            showLevelUpPopup();
            return;
        }
    } else if (gameMode === 'stem') {
        if (level === 15) {
            gameClear();
            return;
        } else {
            level++;
            el('#level').textContent = level;
            showLevelUpPopup();
            return;
        }
    }
    newOrder(true);
}

function gameOver(reason) {
  playSound('fail');
  
  // 현재 점수를 최고 점수 리스트에 추가
  highScores.push(score);
  highScores = highScores.sort((a,b)=>b-a).slice(0,5);
  updateLeaderboard();
  saveHighScores();
  
  const modal=el('#result');
  el('#resultTitle').textContent = "😭 게임 오버";
  el('#resultTitle').style.color = 'var(--bad)';
  el('#resultMsg').innerHTML = `<strong>사유: ${reason}</strong>`;
  el('#resultStats').innerHTML = `<div class="stat-row"><span>최종 점수</span><span>${score}</span></div><div class="stat-row"><span>최종 레벨</span><span>${level}</span></div>`;

  el('#next').style.display = 'none';
  el('#resultMarketBtn').style.display = 'inline-flex';
  if (score >= 10000) {
    el('#continueBtn').style.display = 'flex';
  } else {
    el('#continueBtn').style.display = 'none';
  }
  modal.showModal();
}

function transitionToStemMode() {
    level = 11;
    el('#level').textContent = level;
    
    // 보유 아이템 100% 환불
    let refundTotal = 0;
    marketItems.powerUps.forEach(item => {
        if (inventory[item.id] > 0) {
            const refundAmount = item.price * inventory[item.id];
            refundTotal += refundAmount;
            inventory[item.id] = 0;
        }
    });
    
    if (refundTotal > 0) {
        score += refundTotal;
        el('#score').textContent = score;
        showToast(`아이템 환불 완료! +${refundTotal}💎`);
    }
    
    updateInventoryBar();
    
    const modal = el('#levelUpModal');
    const textEl = el('#levelUpText');
    textEl.textContent = "줄기 MODE로 UP!";
    showFireworks(modal, 50);
    
    const modeBtn = el('#modeBtn');
    modeBtn.textContent = '줄기';
    modeBtn.className = 'stem-mode';
    gameMode = 'stem';
    
    textEl.style.animation = 'none'; textEl.offsetHeight; textEl.style.animation = '';
    modal.showModal();
    setTimeout(() => { modal.close(); newOrder(); }, 3000);
}

function gameClear() {
    // 보유 아이템 100% 환불
    let refundTotal = 0;
    marketItems.powerUps.forEach(item => {
        if (inventory[item.id] > 0) {
            const refundAmount = item.price * inventory[item.id];
            refundTotal += refundAmount;
            inventory[item.id] = 0;
        }
    });
    
    if (refundTotal > 0) {
        score += refundTotal;
        el('#score').textContent = score;
    }
    
    updateInventoryBar();
    
    const modal = el('#levelUpModal');
    const textEl = el('#levelUpText');
    textEl.textContent = "꽃 MODE로 UP!";
    showFireworks(modal, 70);
    
    textEl.style.animation = 'none'; textEl.offsetHeight; textEl.style.animation = '';

    modal.showModal();
    setTimeout(() => {
        modal.close();
        if (refundTotal > 0) {
            showToast(`아이템 환불 완료! +${refundTotal}💎`);
        }
        startFlowerMode();
    }, 3000);
}

function startFlowerMode() {
    gameMode = 'flower';
    const modeBtn = el('#modeBtn');
    modeBtn.textContent = '꽃';
    modeBtn.className = 'flower-mode';
    el('#levelDisplay').style.display = 'none';
    
    updateInventoryBar(); // 인벤토리 바 숨기기
    newOrder(true);
}

function flowerGameOver() {
    // 현재 점수를 최고 점수 리스트에 추가
    highScores.push(score);
    highScores = highScores.sort((a,b)=>b-a).slice(0,5);
    updateLeaderboard();
    saveHighScores();
    
    const finalScoreModal = el('#finalScoreScreen');
    el('#finalScoreValue').textContent = score;
    
    // 최고 점수 리스트 표시
    const finalLeaderboard = el('#finalLeaderboard');
    if(highScores.length > 0){
        finalLeaderboard.innerHTML = `<div class="leaderboard"><h4>🏆 최고 기록</h4>${highScores.map((s,i)=>`<div class="lb-item"><span>#${i+1}</span><span>${s}점</span></div>`).join('')}</div>`;
    } else {
        finalLeaderboard.innerHTML = '';
    }
    
    finalScoreModal.showModal();
    setTimeout(() => {
        finalScoreModal.close();
        resetGame();
    }, 5000);
}

function showFireworks(modal, count = 30) {
    const fireworksContainer = modal.querySelector('.fireworks-container');
    fireworksContainer.innerHTML = '';
    
    const colors = ['#f97316', '#fb923c', '#f59e0b', '#fff', '#fdba74'];
    for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        const angle = Math.random() * 360;
        const radius = Math.random() * 150 + 80;
        const x = Math.cos(angle * (Math.PI / 180)) * radius;
        const y = Math.sin(angle * (Math.PI / 180)) * radius;

        particle.style.setProperty('--x', `${x}vw`);
        particle.style.setProperty('--y', `${y}vh`);
        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
        fireworksContainer.appendChild(particle);
    }
}

function showLevelUpPopup() {
  const modal = el('#levelUpModal');
  const textEl = el('#levelUpText');
  textEl.textContent = `${level-1}단계 통과!`;
  
  showFireworks(modal);
  
  textEl.style.animation = 'none';
  textEl.offsetHeight;
  textEl.style.animation = ''; 
  
  modal.showModal();
  setTimeout(() => {
    modal.close();
    newOrder();
  }, 2000);
}

function showComboPopup(callback) {
  const modal = el('#comboModal');
  const textEl = el('#comboText');
  textEl.textContent = `${combo}콤보 축하!`;
  
  showFireworks(modal);
  
  textEl.style.animation = 'none';
  textEl.offsetHeight;
  textEl.style.animation = ''; 
  
  modal.showModal();
  setTimeout(() => {
    modal.close();
    if(callback) callback();
  }, 2000);
}

function showScorePopup(callback) {
  const modal = el('#scorePopupModal');
  const textEl = el('#scorePopupText');
  textEl.textContent = '+10,000점!';
  
  showFireworks(modal, 40);
  
  textEl.style.animation = 'none';
  textEl.offsetHeight;
  textEl.style.animation = ''; 
  
  modal.showModal();
  setTimeout(() => {
    modal.close();
    if(callback) callback();
  }, 1500);
}

function updateLeaderboard(){
  const section=el('#leaderboard');
  if(highScores.length > 0){
    section.innerHTML=`<div class="leaderboard"><h4>🏆 최고 기록</h4>${highScores.map((s,i)=>`<div class="lb-item"><span>#${i+1}</span><span>${s}점</span></div>`).join('')}</div>`;
  } else {
    section.innerHTML = '';
  }
}

function firstMismatchIndex(a,b){
  const n=Math.min(a.length,b.length);
  for(let i=0;i<n;i++)if(a[i]!==b[i])return i;
  if(a.length!==b.length)return n;
  return-1;
}

function nameOf(key){
  return(ALL.find(i=>i.key===key)||{}).name||key;
}

function toggleGhost(){
  if(!started) return;
  if (gameMode === 'flower') { showToast('꽃 모드에서는 힌트를 볼 수 없어요!'); return; }
  ghostShown=!ghostShown;
  clearStack(el('#target'));drawStack(el('#target'),target.seq,ghostShown);
  showToast(ghostShown?'👻 힌트 표시':'일반 모드');
}

function startGame(){
  if (!sfxAudioCtx) {
    try { sfxAudioCtx = new(window.AudioContext || window.webkitAudioContext)(); }
    catch(e) { console.error("SFX Audio Context could not be created."); }
  }
  
  started=true;
  el('header').classList.add('game-started');
  
  const modeBtn = el('#modeBtn');
  modeBtn.textContent = '새싹';
  modeBtn.className = 'sprout-mode';
  
  // 게임 시작 시 재료 순서를 원래대로 복원
  ALL = [...ORIGINAL_INGREDIENTS];
  drawPalette();
  
  // 새싹 모드에서 인벤토리 바 표시
  updateInventoryBar();

  startBGM().then(()=>{ 
    if(audioCtx && audioCtx.state==='suspended') audioCtx.resume();
    if(sfxAudioCtx && sfxAudioCtx.state === 'suspended') sfxAudioCtx.resume();
    bgmFadeTo(Number(window.__BGM_USER_VOL ?? 0.6), 250);
  });
  
  el('#banner').classList.remove('hide');
  newOrder();
  showToast('🎮 게임 시작!');
}

function resetGame(){
  gameMode = 'sprout';
  started = false;
  el('header').classList.remove('game-started');
  el('#banner').classList.add('hide');
  el('#next').style.display = 'flex';
  el('#continueBtn').style.display = 'none';
  el('#resultMarketBtn').style.display = 'inline-flex';
  el('#levelDisplay').style.display = 'inline';

  stopBGM();
  if (countdownTimerId) clearInterval(countdownTimerId);
  
  score=0;combo=0;level=1;
  target=null;mine=[];
  lastOrder = null;
  inventory = { timeAdd: 0, stagePass: 0, scoreDoubler: 0 };
  unlockedCosmetics = { plates: ['default'], backgrounds: ['default'] };
  activeCosmetics = { plate: 'default', background: 'default' };
  document.body.className = '';
  
  // 재료 순서를 원래대로 복원
  ALL = [...ORIGINAL_INGREDIENTS];
  drawPalette();
  
  // 최고 점수는 유지 (삭제하지 않음)
  
  el('#score').textContent='0';
  el('#level').textContent='1';
  updateLeaderboard();
  
  drawStack(el('#target'), [], false);
  drawStack(el('#mine'), [], false);
  updateInventoryBar();
  showToast('🔄 게임이 초기화되었습니다');
}

document.addEventListener('DOMContentLoaded',()=>{
  loadHighScores();
  drawPalette();
  el('#resetBtn').addEventListener('click',resetGame);
  el('#startBtn').addEventListener('click',startGame);
  el('#undo').addEventListener('click',undo);
  el('#clear').addEventListener('click',resetMine);
  el('#submit').addEventListener('click',() => check());
  el('#peekBtn').addEventListener('click',toggleGhost);
  
  el('#resultMarketBtn').addEventListener('click', openMarket);
  el('#closeMarketModal').addEventListener('click', () => el('#marketModal').close());

  el('#continueBtn').addEventListener('click', () => {
    if (score >= 10000) {
      score -= 10000;
      combo = 0;
      el('#score').textContent = score;
      el('#result').close();
      el('#next').style.display = 'flex';
      el('#continueBtn').style.display = 'none';
      el('#resultMarketBtn').style.display = 'inline-flex';
      newOrder(true);
    } else {
      showToast('💎 다이아가 부족합니다!');
    }
  });

  el('#closeModal').addEventListener('click',()=>{
    el('#result').close();
    resetGame();
  });
});

function openMarket() {
    el('#marketScore').textContent = score;
    const marketItemsContainer = el('#market-items');
    
    const isPurchaseDisabled = gameMode === 'stem' || gameMode === 'flower';

    let shopHtml = '<h4>능력 아이템 (구매)</h4><div class="item-grid">';
    marketItems.powerUps.forEach(item => {
        const isDisabled = isPurchaseDisabled || score < item.price;
        shopHtml += `
            <div class="item-card">
                <div class="item-icon">${item.visual}</div>
                <div class="item-name">${item.name}</div>
                <div class="item-desc">${item.desc}</div>
                <div class="item-price">💎 ${item.price}</div>
                <button class="btn primary buy-item" data-id="${item.id}" data-type="powerUps" ${isDisabled ? 'disabled' : ''}>구매</button>
                ${isPurchaseDisabled ? '<div style="color: var(--bad); font-size: 10px; margin-top: 4px;">이 모드에서는 구매 불가</div>' : ''}
            </div>`;
    });
    shopHtml += '</div>';
    
    let cosmeticsHtml = '<h4>꾸미기 아이템</h4><div class="item-grid">';
    marketItems.cosmetics.forEach(item => {
        const isUnlocked = unlockedCosmetics[item.type].includes(item.id);
        const isActive = activeCosmetics[item.type.slice(0,-1)] === item.id;
        const isDisabled = isPurchaseDisabled || score < item.price;
        
        cosmeticsHtml += `
            <div class="item-card cosmetic-item" data-id="${item.id}" data-type="${item.type}" data-unlocked="${isUnlocked}" data-active="${isActive}">
                <div class="item-icon">${item.visual}</div>
                <div class="item-name">${item.name}</div>
                ${isUnlocked ? `<div class="equipped">${isActive ? '적용중' : ''}</div><button class="btn secondary refund-item" data-id="${item.id}" data-item-type="${item.type}">환불</button>` : `<div class="item-price">💎 ${item.price}</div><button class="btn primary buy-item" data-id="${item.id}" data-type="cosmetics" ${isDisabled ? 'disabled' : ''}>구매</button>${isPurchaseDisabled ? '<div style="color: var(--bad); font-size: 10px; margin-top: 4px;">이 모드에서는 구매 불가</div>' : ''}`}
            </div>`;
    });
    cosmeticsHtml += '</div>';
    
    marketItemsContainer.innerHTML = shopHtml + cosmeticsHtml;
    el('#marketModal').showModal();

    el('#marketModal').querySelectorAll('.buy-item').forEach(btn => btn.addEventListener('click', handleBuyItem));
    el('#marketModal').querySelectorAll('.refund-item').forEach(btn => btn.addEventListener('click', handleRefundItem));
    el('#marketModal').querySelectorAll('.cosmetic-item').forEach(card => {
        card.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') return;
            handleEquipItem(card.dataset.id, card.dataset.type, card.dataset.unlocked);
        });
    });
}

function handleBuyItem(e) {
    // 줄기/꽃 모드에서는 구매 불가
    if (gameMode === 'stem' || gameMode === 'flower') {
        showToast('이 모드에서는 아이템을 구매할 수 없어요!');
        return;
    }
    
    const { id, type } = e.target.dataset;
    const item = marketItems[type].find(i => i.id === id);
    if (score >= item.price) {
        score -= item.price;
        playSound('coin');
        if (type === 'powerUps') {
            inventory[id]++;
        } else {
            unlockedCosmetics[item.type].push(id);
            handleEquipItem(id, item.type, 'true', true);
        }
        showToast(`${item.name} 구매 완료!`);
        openMarket();
        updateInventoryBar();
    } else {
        showToast('💎 다이아가 부족합니다!');
    }
}

function handleUseItem(id) {
    // 줄기 모드와 꽃 모드에서는 아이템 사용 불가
    if (gameMode === 'stem' || gameMode === 'flower') {
        showToast('이 모드에서는 아이템을 사용할 수 없어요!');
        return;
    }
    
    if (inventory[id] > 0) {
        inventory[id]--;
        
        switch(id) {
            case 'timeAdd': timeLeft += 5; el('#countdown-timer').textContent = `남은 시간: ${timeLeft}초`; showToast('시간 +5초 적용!'); break;
            case 'stagePass': showToast('현재 버거 통과!'); check(true); break;
            case 'scoreDoubler': scoreMultiplier = 2; showToast('다음 성공 시 점수 2배!'); break;
        }
        updateInventoryBar();
    }
}

function handleEquipItem(id, type, unlocked, fromPurchase = false) {
    if (unlocked !== 'true') return;

    const singularType = type === 'plates' ? 'plate' : 'background';
    activeCosmetics[singularType] = id;
    
    if(type === 'backgrounds') { document.body.className = `theme-${id}`; }
    
    drawStack(el('#target'), target ? target.seq : [], ghostShown);
    drawStack(el('#mine'), mine, false);
    if (!fromPurchase) showToast('꾸미기 아이템 적용 완료!');
    openMarket();
}

function handleRefundItem(e) {
    e.stopPropagation();
    const { id, itemType } = e.target.dataset;
    const item = marketItems.cosmetics.find(i => i.id === id && i.type === itemType);
    
    const index = unlockedCosmetics[itemType].indexOf(id);
    if (index > -1) {
        unlockedCosmetics[itemType].splice(index, 1);
    }
    
    const refundAmount = Math.floor(item.price / 2);
    score += refundAmount;
    showToast(`${item.name} 환불 완료! +${refundAmount}💎`);
    
    const singularType = itemType.slice(0, -1);
    if (activeCosmetics[singularType] === id) {
        activeCosmetics[singularType] = 'default';
        if (itemType === 'backgrounds') {
            document.body.className = '';
        }
        drawStack(el('#target'), target ? target.seq : [], ghostShown);
        drawStack(el('#mine'), mine, false);
    }
    
    openMarket();
}

function updateInventoryBar() {
    const inventoryBar = el('#inventory-bar');
    
    // 줄기 모드와 꽃 모드에서는 인벤토리 바 숨기기
    if (gameMode === 'stem' || gameMode === 'flower') {
        inventoryBar.classList.add('hidden');
        return;
    }
    
    inventoryBar.classList.remove('hidden');
    inventoryBar.innerHTML = '';
    marketItems.powerUps.forEach(item => {
        if (inventory[item.id] > 0) {
            const itemEl = document.createElement('div');
            itemEl.className = 'inventory-item';
            itemEl.innerHTML = `<div class="item-icon">${item.visual}</div><div class="item-count">${inventory[item.id]}</div>`;
            itemEl.onclick = () => handleUseItem(item.id);
            inventoryBar.appendChild(itemEl);
        }
    });
}

function saveHighScores() {
    localStorage.setItem('hamburgerMasterHighScores', JSON.stringify(highScores));
}

function loadHighScores() {
    const savedScores = localStorage.getItem('hamburgerMasterHighScores');
    if (savedScores) {
        highScores = JSON.parse(savedScores);
    }
    updateLeaderboard();
}


let audioCtx=null, masterGain=null, bgmPlaying=false;
let schedulerTimer=null, nextNoteTime=0, current16th=0;
const bpm = 118, secondsPerBeat = 60.0 / bpm, scheduleAheadTime = 0.12, lookahead = 25;
const arpScale = [0, 3, 7, 10, 14, 17], baseNote = 50, bassNote = 38;
let delayNode, feedbackGain;

function midiToFreq(m){ return 440 * Math.pow(2,(m-69)/12); }
async function ensureAudio(){ if(audioCtx) return; audioCtx = new (window.AudioContext || window.webkitAudioContext)(); masterGain = audioCtx.createGain(); masterGain.gain.value = (window.__BGM_USER_VOL ?? 0.6); delayNode = audioCtx.createDelay(0.5); delayNode.delayTime.value = 0.38; feedbackGain = audioCtx.createGain(); feedbackGain.gain.value = 0.35; delayNode.connect(feedbackGain); feedbackGain.connect(delayNode); delayNode.connect(masterGain); masterGain.connect(audioCtx.destination); }
function envGain(durationMs=200, peak=0.8){ const g = audioCtx.createGain(); g.gain.setValueAtTime(0, audioCtx.currentTime); const now = audioCtx.currentTime; g.gain.linearRampToValueAtTime(peak, now + 0.002); g.gain.exponentialRampToValueAtTime(0.0001, now + durationMs/1000); return g; }
function scheduleKick(t){ const osc = audioCtx.createOscillator(), g = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(130, t); osc.frequency.exponentialRampToValueAtTime(45, t+0.12); g.gain.setValueAtTime(0.0001, t); g.gain.exponentialRampToValueAtTime(0.9, t+0.002); g.gain.exponentialRampToValueAtTime(0.0001, t+0.18); osc.connect(g); g.connect(masterGain); osc.start(t); osc.stop(t+0.2); }
function scheduleHat(t){ const bufferSize = 2048, noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate), data = noiseBuffer.getChannelData(0); for(let i=0;i<bufferSize;i++){ data[i] = Math.random()*2-1; } const noise = audioCtx.createBufferSource(); noise.buffer = noiseBuffer; const hpf = audioCtx.createBiquadFilter(); hpf.type = 'highpass'; hpf.frequency.value = 6000; const g = audioCtx.createGain(); g.gain.setValueAtTime(0.0001, t); g.gain.exponentialRampToValueAtTime(0.4, t+0.005); g.gain.exponentialRampToValueAtTime(0.0001, t+0.06); noise.connect(hpf); hpf.connect(g); g.connect(masterGain); noise.start(t); noise.stop(t+0.07); }
function scheduleBass(t){ const osc = audioCtx.createOscillator(), lpf = audioCtx.createBiquadFilter(); lpf.type = 'lowpass'; lpf.frequency.setValueAtTime(260, t); const g = envGain(350, 0.6); osc.type='triangle'; osc.frequency.setValueAtTime(midiToFreq(bassNote), t); osc.connect(lpf); lpf.connect(g); g.connect(masterGain); osc.start(t); osc.stop(t+0.37); }
function scheduleArp(t, degreeIndex){ const osc = audioCtx.createOscillator(), lpf = audioCtx.createBiquadFilter(); lpf.type = 'lowpass'; lpf.frequency.setValueAtTime(1800, t); const g = envGain(400, 0.35); osc.type='triangle'; const midi = baseNote + arpScale[degreeIndex % arpScale.length]; osc.frequency.setValueAtTime(midiToFreq(midi), t); osc.detune.setValueAtTime(0, t); osc.detune.linearRampToValueAtTime(3, t+0.1); osc.connect(lpf); lpf.connect(g); g.connect(masterGain); g.connect(delayNode); osc.start(t); osc.stop(t+0.4); }
function nextNote(){ const secondsPer16th = secondsPerBeat/4; nextNoteTime += secondsPer16th; current16th = (current16th + 1) % 64; }
function scheduleNote(){ if(current16th % 4 === 0){ scheduleKick(nextNoteTime); } if(current16th % 2 === 0){ scheduleHat(nextNoteTime); } if(current16th % 16 === 0){ scheduleBass(nextNoteTime); } const motif = [0,3,7,10,7,3,0,3,  5,8,12,15,12,8,5,8]; const idx = current16th % motif.length; scheduleArp(nextNoteTime, motif[idx]); }
function scheduler(){ while(audioCtx && nextNoteTime < audioCtx.currentTime + scheduleAheadTime){ scheduleNote(); nextNote(); } }
async function startBGM(){ await ensureAudio(); if(bgmPlaying) return; const now = audioCtx.currentTime; nextNoteTime = now + 0.05; current16th = 0; schedulerTimer = setInterval(scheduler, lookahead); bgmPlaying = true; }
function stopBGM(){ if(schedulerTimer){ clearInterval(schedulerTimer); schedulerTimer=null; } bgmPlaying=false; }
function bgmFadeTo(target, ms=300){ if(!audioCtx || !masterGain) return; const now = audioCtx.currentTime; masterGain.gain.cancelScheduledValues(now); masterGain.gain.setValueAtTime(masterGain.gain.value, now); masterGain.gain.linearRampToValueAtTime(target, now + ms/1000); }
document.addEventListener('visibilitychange', ()=>{ if(!audioCtx) return; if(document.hidden) audioCtx.suspend(); else audioCtx.resume(); });
</script>
</body>
</html>
